name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'main'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prune dev dependencies
        run: npm prune --production

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.ts \
            ecosystem.config.js \
            server \
            src \
            drizzle.config.ts \
            tsconfig.json \
            node_modules \
            CHANGELOG-*.md

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy.tar.gz
          retention-days: 1

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp"
          overwrite: true

      - name: Setup release on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 5m
          script: |
            set -e

            APP_DIR="/var/www/filmber"
            RELEASE_TIMESTAMP=$(date +%Y%m%d%H%M%S)
            RELEASE_DIR="${APP_DIR}/releases/${RELEASE_TIMESTAMP}"

            echo "Starting deployment ${RELEASE_TIMESTAMP}..."

            # Создаем директории
            mkdir -p "${RELEASE_DIR}"
            mkdir -p "${APP_DIR}/logs"

            # Распаковываем артефакты
            echo "Extracting deployment package..."
            tar -xzf /tmp/deploy.tar.gz -C "${RELEASE_DIR}"
            rm -f /tmp/deploy.tar.gz

            # Линкуем .env
            ln -sf "${APP_DIR}/shared/.env" "${RELEASE_DIR}/.env"

            # Миграции базы данных
            cd "${RELEASE_DIR}"
            set -a
            source "${APP_DIR}/shared/.env"
            set +a
            echo "Running database migrations..."
            npx drizzle-kit migrate || echo "Migration failed or no migrations to apply"

            # Переключаем релиз
            ln -sfn "${RELEASE_DIR}" "${APP_DIR}/current"

            # Перезапуск PM2 (graceful reload)
            cd "${APP_DIR}/current"
            # Find process by partial name match to avoid GitHub secret masking
            PM2_ID=$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name | contains("film")) | .pm_id' | head -1)
            if [ -n "$PM2_ID" ]; then
              echo "Reloading existing PM2 process (ID: $PM2_ID)..."
              pm2 reload "$PM2_ID" --update-env
            else
              echo "Starting new PM2 process..."
              pm2 start ecosystem.config.js --env production
            fi
            pm2 save

            # Очистка старых релизов (оставляем 5)
            cd "${APP_DIR}/releases"
            ls -1t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true

            echo "Deployment completed: ${RELEASE_TIMESTAMP}"

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            sleep 5
            # Check via HTTP endpoint instead of PM2 name (avoid secret masking)
            HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:3000/api/health || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed! (HTTP $HTTP_CODE)"
            else
              echo "Health check failed! (HTTP $HTTP_CODE)"
              pm2 list
              exit 1
            fi

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Deployment failed, attempting rollback..."
            APP_DIR="/var/www/filmber"
            PREV_RELEASE=$(ls -1t "${APP_DIR}/releases" | sed -n '2p')
            if [ -n "$PREV_RELEASE" ]; then
              ln -sfn "${APP_DIR}/releases/${PREV_RELEASE}" "${APP_DIR}/current"
              cd "${APP_DIR}/current"
              # Use pm2 list to find process and reload by ID
              PM2_ID=$(pm2 jlist | jq -r '.[] | select(.name | contains("film")) | .pm_id' | head -1)
              if [ -n "$PM2_ID" ]; then
                pm2 reload "$PM2_ID" --update-env
              else
                pm2 start ecosystem.config.js --env production
              fi
              echo "Rolled back to ${PREV_RELEASE}"
            fi
