name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'main'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prune dev dependencies
        run: npm prune --production

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.ts \
            ecosystem.config.js \
            server \
            src \
            drizzle.config.ts \
            tsconfig.json \
            node_modules \
            CHANGELOG-*.md

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy.tar.gz
          retention-days: 1

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp"
          overwrite: true

      - name: Setup release on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 5m
          script: |
            set -e

            APP_DIR="/var/www/filmber"
            RELEASE_TIMESTAMP=$(date +%Y%m%d%H%M%S)
            RELEASE_DIR="${APP_DIR}/releases/${RELEASE_TIMESTAMP}"

            BUILD_VERSION="${{ github.sha }}"
            echo "Starting deployment ${RELEASE_TIMESTAMP}..."
            echo "Build version: ${BUILD_VERSION}"

            # Создаем директории
            mkdir -p "${RELEASE_DIR}"
            mkdir -p "${APP_DIR}/logs"

            # Распаковываем артефакты
            echo "Extracting deployment package..."
            tar -xzf /tmp/deploy.tar.gz -C "${RELEASE_DIR}"
            rm -f /tmp/deploy.tar.gz

            # Линкуем .env
            ln -sf "${APP_DIR}/shared/.env" "${RELEASE_DIR}/.env"

            # Линкуем uploads из shared директории (для сохранения постеров между деплоями)
            if [ -d "${APP_DIR}/shared/uploads" ]; then
              rm -rf "${RELEASE_DIR}/public/uploads"
              ln -sf "${APP_DIR}/shared/uploads" "${RELEASE_DIR}/public/uploads"
              echo "uploads directory linked"
            else
              echo "Creating shared/uploads directory..."
              mkdir -p "${APP_DIR}/shared/uploads/posters"
              rm -rf "${RELEASE_DIR}/public/uploads"
              ln -sf "${APP_DIR}/shared/uploads" "${RELEASE_DIR}/public/uploads"
            fi

            # Rebuild esbuild for server platform (fixes cross-platform binary issues)
            echo "Rebuilding esbuild for server platform..."
            cd "${RELEASE_DIR}/node_modules/tsx/node_modules"
            rm -rf esbuild
            npm install esbuild@0.27.2 --no-save --silent

            # Миграции базы данных
            cd "${RELEASE_DIR}"
            set -a
            source "${APP_DIR}/shared/.env"
            set +a
            echo "Running database migrations..."
            npx drizzle-kit migrate || echo "Migration failed or no migrations to apply"

            # Save build version for monitoring
            echo "${BUILD_VERSION}" > "${RELEASE_DIR}/.build-version"

            # Переключаем релиз
            ln -sfn "${RELEASE_DIR}" "${APP_DIR}/current"

            # Перезапуск PM2 (delete and start fresh to ensure correct cwd)
            cd "${APP_DIR}/current"
            echo "Stopping all filmber processes..."

            # 1. Stop PM2 managed process (both root and filmber user)
            pm2 stop filmber 2>/dev/null || true
            pm2 delete filmber 2>/dev/null || true
            sudo -u filmber pm2 delete filmber 2>/dev/null || true
            sudo -u filmber pm2 save --force 2>/dev/null || true
            sleep 2

            # 2. Kill node processes on port 3000 (safer than pkill with broad pattern)
            # Using fuser which only kills the actual process holding the port
            fuser -k -9 3000/tcp 2>/dev/null || true
            sleep 2

            # 3. Verify port is free (with retries)
            echo "Verifying port 3000 is free..."
            for i in {1..5}; do
              if ! fuser 3000/tcp >/dev/null 2>&1; then
                echo "Port 3000 is free"
                break
              fi
              echo "Port 3000 still in use (attempt $i), force killing..."
              fuser -k -9 3000/tcp 2>/dev/null || true
              sleep 2
            done

            # 4. Final check - fail if port still in use
            if fuser 3000/tcp >/dev/null 2>&1; then
              echo "ERROR: Port 3000 still in use after all attempts!"
              fuser -v 3000/tcp
              exit 1
            fi

            pm2 start ecosystem.config.js --env production
            pm2 save

            # Очистка старых релизов (оставляем 5)
            cd "${APP_DIR}/releases"
            ls -1t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true

            echo "Deployment completed: ${RELEASE_TIMESTAMP}"

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Waiting for app to start..."
            echo "Expected build: ${{ github.sha }}"

            # tsx/Next.js needs time to compile and start
            for i in {1..12}; do
              sleep 5
              HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:3000/api/health 2>/dev/null || echo "000")
              if [ "$HTTP_CODE" = "200" ]; then
                DEPLOYED_VERSION=$(cat /var/www/filmber/current/.build-version 2>/dev/null || echo "unknown")
                echo "Health check passed! (HTTP $HTTP_CODE)"
                echo "Deployed version: ${DEPLOYED_VERSION}"
                exit 0
              fi
              echo "Attempt $i: HTTP $HTTP_CODE, waiting..."
            done

            echo "Health check failed after 60s!"
            pm2 list
            pm2 logs filmber --nostream --lines 20
            exit 1

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Deployment failed, attempting rollback..."
            APP_DIR="/var/www/filmber"
            PREV_RELEASE=$(ls -1t "${APP_DIR}/releases" | sed -n '2p')
            if [ -n "$PREV_RELEASE" ]; then
              ln -sfn "${APP_DIR}/releases/${PREV_RELEASE}" "${APP_DIR}/current"
              cd "${APP_DIR}/current"

              # Kill processes before rollback (using fuser, not pkill)
              pm2 delete filmber 2>/dev/null || true
              fuser -k -9 3000/tcp 2>/dev/null || true
              sleep 2

              pm2 start ecosystem.config.js --env production
              pm2 save
              echo "Rolled back to ${PREV_RELEASE}"
            fi
