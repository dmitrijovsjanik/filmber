name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'main'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prune dev dependencies
        run: npm prune --production

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.ts \
            ecosystem.config.js \
            server \
            src \
            drizzle.config.ts \
            tsconfig.json \
            node_modules \
            CHANGELOG-*.md

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy.tar.gz
          retention-days: 1

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp"
          overwrite: true

      - name: Setup release on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 5m
          script: |
            set -e

            APP_DIR="/var/www/filmber"
            RELEASE_TIMESTAMP=$(date +%Y%m%d%H%M%S)
            RELEASE_DIR="${APP_DIR}/releases/${RELEASE_TIMESTAMP}"

            echo "Starting deployment ${RELEASE_TIMESTAMP}..."

            # Создаем директории
            mkdir -p "${RELEASE_DIR}"
            mkdir -p "${APP_DIR}/logs"

            # Распаковываем артефакты
            echo "Extracting deployment package..."
            tar -xzf /tmp/deploy.tar.gz -C "${RELEASE_DIR}"
            rm -f /tmp/deploy.tar.gz

            # Линкуем .env
            ln -sf "${APP_DIR}/shared/.env" "${RELEASE_DIR}/.env"

            # Линкуем uploads из shared директории (для сохранения постеров между деплоями)
            if [ -d "${APP_DIR}/shared/uploads" ]; then
              rm -rf "${RELEASE_DIR}/public/uploads"
              ln -sf "${APP_DIR}/shared/uploads" "${RELEASE_DIR}/public/uploads"
              echo "uploads directory linked"
            else
              echo "Creating shared/uploads directory..."
              mkdir -p "${APP_DIR}/shared/uploads/posters"
              rm -rf "${RELEASE_DIR}/public/uploads"
              ln -sf "${APP_DIR}/shared/uploads" "${RELEASE_DIR}/public/uploads"
            fi

            # Rebuild esbuild for server platform (fixes cross-platform binary issues)
            echo "Rebuilding esbuild for server platform..."
            cd "${RELEASE_DIR}/node_modules/tsx/node_modules"
            rm -rf esbuild
            npm install esbuild@0.27.2 --no-save --silent

            # Миграции базы данных
            cd "${RELEASE_DIR}"
            set -a
            source "${APP_DIR}/shared/.env"
            set +a
            echo "Running database migrations..."
            npx drizzle-kit migrate || echo "Migration failed or no migrations to apply"

            # Переключаем релиз
            ln -sfn "${RELEASE_DIR}" "${APP_DIR}/current"

            # Перезапуск PM2 (delete and start fresh to ensure correct cwd)
            cd "${APP_DIR}/current"
            echo "Restarting PM2 process..."
            pm2 delete filmber 2>/dev/null || true
            sleep 2
            # Kill any process holding port 3000 to avoid EADDRINUSE
            fuser -k 3000/tcp 2>/dev/null || true
            sleep 1
            pm2 start ecosystem.config.js --env production
            pm2 save

            # Очистка старых релизов (оставляем 5)
            cd "${APP_DIR}/releases"
            ls -1t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true

            echo "Deployment completed: ${RELEASE_TIMESTAMP}"

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            sleep 5
            # Check via HTTP endpoint instead of PM2 name (avoid secret masking)
            HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:3000/api/health || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed! (HTTP $HTTP_CODE)"
            else
              echo "Health check failed! (HTTP $HTTP_CODE)"
              pm2 list
              exit 1
            fi

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Deployment failed, attempting rollback..."
            APP_DIR="/var/www/filmber"
            PREV_RELEASE=$(ls -1t "${APP_DIR}/releases" | sed -n '2p')
            if [ -n "$PREV_RELEASE" ]; then
              ln -sfn "${APP_DIR}/releases/${PREV_RELEASE}" "${APP_DIR}/current"
              cd "${APP_DIR}/current"
              pm2 delete filmber 2>/dev/null || true
              pm2 start ecosystem.config.js --env production
              pm2 save
              echo "Rolled back to ${PREV_RELEASE}"
            fi
